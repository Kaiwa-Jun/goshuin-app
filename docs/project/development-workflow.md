# 開発ワークフロー

## 概要

このプロジェクトは、TDD（テスト駆動開発）と仕様駆動開発を組み合わせた開発フローを採用しています。
Claude Codeと協調して効率的に開発を進めるためのガイドラインです。

## 開発フロー全体像

```
┌─────────────────────────────────────────────────────────────────────┐
│                         開発フロー                                   │
└─────────────────────────────────────────────────────────────────────┘

【Phase 1: 探索・計画】(Plan Mode)
┌────────────────────────────────────────────────────────────────────┐
│ 1. GitHub Issueで機能要件を起票（または口頭で説明）                    │
│ 2. Claude が自動で Plan Mode に入り、コードベースを探索               │
│    └─ Subagent で関連ファイルを調査（main context を汚さない）        │
│ 3. 詳細設計を docs/issues/issue-XXX-*.md に保存                      │
│ 4. /clear でコンテキストクリア                                        │
└────────────────────────────────────────────────────────────────────┘

【Phase 1.5: チーム構成の判断】
┌────────────────────────────────────────────────────────────────────┐
│ Issue の規模と特性に応じてエージェントチームを構成するか判断          │
│                                                                     │
│ チーム構成する場合:                                                   │
│ ├─ リーダー（Opus）: タスク分割・割り当て・統合                      │
│ ├─ 実装メンバー（Sonnet）: 担当領域のコード実装                      │
│ ├─ テストメンバー（Sonnet）: テストコード作成                        │
│ └─ レビューメンバー（Sonnet）: コードレビュー（必要時のみ）          │
│                                                                     │
│ チーム構成しない場合:                                                 │
│ └─ そのまま Phase 2 へ進む                                           │
└────────────────────────────────────────────────────────────────────┘

【Phase 2: TDD実装】(Normal Mode / チームの各メンバー)
┌────────────────────────────────────────────────────────────────────┐
│ docs/issues/*.md を参照して実装開始                                  │
│                                                                     │
│ 1. [Red]    失敗するテストを書く                                     │
│ 2. [Green]  テストが通る最小限の実装                                  │
│ 3. [Refactor] テストを通したままリファクタ                             │
│ 4. 検証: npm test / npm run lint / npm run typecheck                │
└────────────────────────────────────────────────────────────────────┘

【Phase 3: CI/CD】
┌────────────────────────────────────────────────────────────────────┐
│ ローカル (Husky)                                                    │
│ ├─ git commit → [pre-commit] lint-staged (lint + format)           │
│ └─ git push   → [pre-push] typecheck + test                        │
│                                                                     │
│ GitHub Actions                                                      │
│ └─ PR作成     → Claude Code による PR Review + lint + test          │
└────────────────────────────────────────────────────────────────────┘
```

## Phase 1: 探索・計画

### 新機能を実装する前に

1. **要件を明確化**
   - GitHub Issue を作成するか、口頭で要件を説明
   - 不明点があれば Claude に質問させる

2. **Plan Mode で設計**
   - Claude が自動的に Plan Mode に入る（大きな変更の場合）
   - Subagent を使ってコードベースを探索
   - 既存パターンとの整合性を確認

3. **設計ドキュメントを保存**
   - `docs/issues/issue-XXX-feature-name.md` に詳細設計を保存
   - テンプレートは `docs/issues/README.md` を参照

4. **コンテキストをクリア**
   - `/clear` を実行してコンテキストをリセット
   - クリーンな状態で実装を開始

## Phase 1.5: チーム構成の判断（エージェントチーム）

Issue の実装に着手する前に、エージェントチームを構成するかどうかを判断する。

### チームを構成すべき条件

以下のいずれかに該当する場合、チームを構成する:

1. **3つ以上の独立したファイル群を並行で作成・変更する**
2. **複数の専門領域にまたがる調査・レビューが必要**
3. **複数の仮説を並行で検証するデバッグ**

### チームを構成すべきでない条件

- 1〜2ファイルの単純な変更
- 順序依存のタスク（前の結果が次に必要）
- 同じファイルを複数人で編集する必要がある場合

### チーム構成ルール

| ロール           | モデル | 説明                                                     |
| ---------------- | ------ | -------------------------------------------------------- |
| リーダー（自分） | Opus   | タスク分割・割り当て・統合。デリゲートモードで調整に専念 |
| 実装メンバー     | Sonnet | 各担当領域のコード実装。1メンバー1領域                   |
| テストメンバー   | Sonnet | テストコードの作成（必要な場合のみ）                     |
| レビューメンバー | Sonnet | コードレビュー・セキュリティチェック（必要な場合のみ）   |

**基本方針:**

- メンバーは全員 Sonnet を使用する（リーダーのみ Opus）
- 1メンバーにつき1つの明確な担当領域を割り当て
- ファイルの衝突を避ける（各メンバーの編集ファイルが重複しないよう分割）
- メンバー数は最小限（2〜4人程度）
- タスクは5〜6個/メンバー
- 複雑なタスクではプラン承認モードを設定

### チーム運用の流れ

1. リーダーがタスクリストを作成し、メンバーに割り当てる
2. リーダーはデリゲートモード（`Shift+Tab`）で調整に専念
3. メンバーが作業を完了したら、リーダーが結果を統合
4. 全タスク完了後、チームをシャットダウン＆クリーンアップ

### チーム構成例

**画面実装の場合:**

```text
チームを作成して地図画面を実装してください。
- メンバー1（ui）: 地図コンポーネントとUI実装（src/screens/, src/components/map/）
- メンバー2（service）: Supabaseデータ取得サービス（src/services/, src/hooks/）
- メンバー3（test）: テストコード作成（src/**/__tests__/）
各メンバーにはSonnetを使ってください。
メンバーが実装を始める前にプラン承認を要求してください。
```

**調査・レビューの場合:**

```text
チームを作成してPR #XXX をレビューしてください。
- メンバー1: セキュリティの観点でレビュー
- メンバー2: パフォーマンスの観点でレビュー
- メンバー3: テストカバレッジの確認
各メンバーにはSonnetを使ってください。
互いの発見を共有して議論してください。
```

## Phase 2: TDD 実装

### Red → Green → Refactor サイクル

1. **Red: 失敗するテストを書く**

   ```typescript
   describe('validateEmail', () => {
     it('should return true for valid email', () => {
       expect(validateEmail('user@example.com')).toBe(true);
     });
   });
   ```

2. **Green: テストを通す最小限の実装**

   ```typescript
   export function validateEmail(email: string): boolean {
     return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
   }
   ```

3. **Refactor: コードを改善**
   - テストが通ったままリファクタリング
   - 重複を除去、命名を改善

### 検証コマンド

```bash
# テスト実行
npm test

# 特定ファイルのみ
npm test -- --testPathPattern="filename"

# lint チェック
npm run lint

# 型チェック
npm run typecheck
```

## Phase 3: CI/CD

### ブランチ戦略

```
main        ← 本番用（直接pushしない）
  ↑
develop     ← 開発用（デフォルトブランチ、PRのマージ先）
  ↑
feature/*   ← 機能開発ブランチ
```

**ルール**:

- PRは `develop` ブランチに向けて作成する
- `main` へのマージはリリース時のみ（develop → main）
- 機能開発は `feature/*` ブランチで行う
- **develop へのcommit/push完了時に、対象の GitHub Issue を `gh issue close <番号>` でクローズする**

### ローカル (Husky)

| Hook       | 実行タイミング  | 内容                            |
| ---------- | --------------- | ------------------------------- |
| pre-commit | `git commit` 時 | lint-staged (ESLint + Prettier) |
| pre-push   | `git push` 時   | typecheck + test                |

### GitHub Actions

PR作成時に自動実行:

1. **Claude PR Review** - コードレビュー
2. **Lint & Type Check** - 静的解析
3. **Test** - テスト実行

## Claude Code の設定

### Skills（自動適用）

| Skill             | 説明                                |
| ----------------- | ----------------------------------- |
| `project-context` | プロジェクト固有の知識              |
| `tdd-workflow`    | チーム判断 + TDDガイドライン        |
| `plan-to-docs`    | 設計→ドキュメント保存のワークフロー |

### Subagents（調査用）

| Agent               | 用途                                       |
| ------------------- | ------------------------------------------ |
| `codebase-explorer` | コードベース探索（main contextを汚さない） |
| `security-reviewer` | セキュリティレビュー                       |

### Hooks（自動実行）

- **PostToolUse (Edit|Write)**: 編集後に自動で ESLint --fix を実行

## セットアップ

### 初回セットアップ

```bash
# 依存関係インストール
npm install

# Husky の初期化
npm run prepare
```

### GitHub Actions の準備

1. リポジトリの Settings → Secrets and variables → Actions
2. `ANTHROPIC_API_KEY` を追加

## ベストプラクティス

### コンテキスト管理

- **タスク間で `/clear`** - 無関係なコンテキストを持ち越さない
- **Subagent で調査** - main context を汚さずに探索
- **2回以上の修正で `/clear`** - 失敗アプローチが溜まったらリセット

### 効果的なプロンプト

```
# Good: 検証手段を含む
「validateEmail関数を実装して。テストケース: user@example.comはtrue、invalidはfalse。
テストを書いてから実装して、テストが通ることを確認して」

# Bad: 検証なし
「メール検証関数を作って」
```

### PRの作成

PRは必ず `develop` ブランチに向けて作成する。

```
# Good: 具体的な指示
「このブランチの変更をコミットして、developに向けてPRを作成して。
変更内容をサマリにまとめて」

# Bad: 曖昧
「PRお願い」
```

```bash
# PR作成コマンド例
gh pr create --base develop --title "feat: 機能名" --body "説明"
```
